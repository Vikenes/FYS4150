\section{The Penning trap}\label{sec:penning_trap}

\begin{figure}[h!]
    \includegraphics[width=\linewidth]{Trap_schematic.png}
    \caption{Schematic of the Penning trap. The cross-section is in the $xz$-plane. The ring electrode (green) and end caps (dark blue) sets the inhomogenoeous electric field (white arrows). The homogeneous magnetic field (blue arrows) is resulting from the cylinder magnet (light blue) outside of the trap. For simplicity, we will assume that the trap extends the distance $d$ in all directions, see text for further details.}
    \label{fig:schematic_trap}
\end{figure}

We consider an ideal Penning trap in three dimensions, with a schematic of the trap shown in figure \ref{fig:schematic_trap}.


\subsection{External electromagnetic fields}\label{subsec_methods:penning_trap_setup}

The electrodes in the Penning trap create an external electric field $\vec{E}_\mathrm{ext}$ defined by the potential
\begin{equation}
    V (\vec{r})= V(x,y,z) = \frac{V_0}{2d^2}(2z^2 - x^2 - y^2), \label{eq:penning_potential}
\end{equation}
where $V_0$ is the potential applied to the electrodes and $d= \sqrt{z_0^2+ \frac{1}{2}r_0^2}$ is the characteristic dimension, where $z_0$ is the distance between the centre and the endcap and $r_0$ is the radius of of the ring. The external electric field resulting from this potential is  
\begin{equation}
    \vec{E}_\mathrm{ext} = -\nabla V = \frac{V_0}{d^2} (x,\,y,\,-2z), \label{eq:p1_E_field_pot_gradient}
\end{equation}
which traps the particles in the $z$-direction. To contain the particles in the $xy$-plane, a constant homogeneous magnetic field $\vec{B}_\mathrm{ext}$ is imposed in the $z$-direction,
\begin{equation}
    \vec{B}_\mathrm{ext} = (0,0,B_0). \label{eq:homogeneous_B_field}
\end{equation}

\Vetle{The discussion below should perhaps be moved to the methods section. It's only a simplification we make in our numerical model.}
As a simplification, we consider the trap as a sphere of radius $d$. We set the external fields to zero outside this region, so the electric field is   
\begin{equation}\label{eq:trap_ext_E_field}
    \vec{E}_\mathrm{ext} (\vec{r}) = 
    \begin{cases}
        \frac{V_0}{d^2} \left( x,\, y,\, -2z \right), & \abs{\vec{r}} \leq d \\
        (0,\,0,\,0),  & \abs{\vec{r}} > d
    \end{cases}, 
\end{equation}
and the magnetic field is 
\begin{equation}\label{eq:trap_ext_B_field}
    \vec{B}_\mathrm{ext} (\vec{r}) = 
    \begin{cases}
        (0,\,0,\,B_0), & \abs{\vec{r}} \leq d \\
        (0,\,0,\,0), & \abs{\vec{r}} > d
    \end{cases}.
\end{equation}


\subsection{Analytical solutions - Single particle}\label{subsec_methods:single_particle_analytical}
We restrict ourselves to dealing with only positively charged particles, $q>0$ \Vetle{Check that this agrees with introduction, maybe move this?}. We begin by considering a single particle in the Penning trap. The Lorentz force is then governed by the external fields only, hence $\vec{E} = \vec{E}_\mathrm{ext}$ and $\vec{B} = \vec{B}_\mathrm{ext}$. We use eq. \eqref{eq:lorentz_force} to compute the Lorentz force, \Vetle{use equation and split on the equation below?}
\begin{align}
    \vec{F} &= \frac{q V_0}{d^2}(x,\,y,\,-2z) + q B_0 (\dot{y},\,-\dot{x},\,0) \nonumber\\
    &= \frac{m}{2}\omega_z^2 (x,\,y,\,-2z) + m \omega_0 (\dot{y},\,-\dot{x},\,0),\label{eq:p1_lorentz_force_penning}
\end{align}
where we defined $\omega_0 \equiv \frac{qB_0}{m}$ and $\omega_z^2 \equiv \frac{2qV_0}{m d^2}$. Using equation \eqref{eq:eom_lorentz} gives us three equations of motion, one for each spatial component, which are 
\begin{subequations}\label{eq:p1_eom_xyz}
    \begin{align}
        \ddot{x} - \omega_0 \dot{y} - \frac{1}{2} \omega_z^2 x &= 0, \label{eq:p1_eom_x} \\ 
        \ddot{y} + \omega_0 \dot{x} - \frac{1}{2} \omega_z^2 y &= 0, \label{eq:p1_eom_y} \\ 
        \ddot{z} + \omega_z^2 z &= 0. \label{eq:p1_eom_z}
    \end{align}
\end{subequations}
The general solution of eq. \eqref{eq:p1_eom_z} is
\begin{equation}
    z(t) = c_1 \cos(\omega_z t) + c_2 \sin(\omega_z t), \label{eq:p1_diffeq_solution_z}
\end{equation}
where $c_1,\, c_2 \in \mathbb{R}$ are determined by initial conditions.

Equations \eqref{eq:p1_eom_x} and \eqref{eq:p1_eom_y} are coupled, so we introduce a complex function $f(t)=x(t) + iy(t)$ to write them as a single differential equation. Multiplying equation \eqref{eq:p1_eom_y} with $i$ and adding it to equation \eqref{eq:p1_eom_x} we obtain the following:
\begin{align}
    \ddot{x} + i\ddot{y} + \omega_0(i\dot{x} - \dot{y}) -\frac{1}{2}\omega_z^2(x+iy) &= 0 \nonumber \\
    (\ddot{x} + i\ddot{y}) + i\omega_0(\dot{x} +i \dot{y}) -\frac{1}{2}\omega_z^2(x+iy) &= 0. \label{eq:p2_eom_rewritten}
\end{align}
We recognize the first and second parentheses as $\ddot{f}$ and $\dot{f}$, repsectively. The differential equation for $f(t)$ is
\begin{equation}
    \ddot{f} + i\omega_0 \dot{f} - \frac{1}{2}\omega_z^2 f = 0, \label{eq:p2_f_complex_equation}
\end{equation}
which has the general solution 
\begin{equation}
    f(t) = A_+ e^{-i(\omega_+ t + \phi_+)} + A_- e^{-i(\omega_- t + \phi_-)}, \label{eq:p3_f_general_solution}
\end{equation}
where $\phi_+$ and $\phi_-$ are constant phases, $A_+$ and $A_-$ are positive amplitudes and 
\begin{equation}
    \omega_\pm = \frac{\omega_0 \pm \sqrt{\omega_0^2 - 2\omega_z^2}}{2}. \label{eq:p3_omega_pm}
\end{equation}
The physical coordinates are then $x(t)=\Re f(t)$ and $y(t)=\Im f(t)$. \Vetle{The following sentence confuses me:} The $\omega_+$ is the modified cyclotron frequency and the $\omega_-$ is the magnetron frequency that composes the two modes in the orbital motion we will discuss later.

In order to have a bounded solution for the particle in the $xy$-plane, we must have $\abs{f(t)} < \infty$ as $t\to\infty$. We see from equation \eqref{eq:p3_f_general_solution} that this condition is fulfilled if $\omega_\pm\in\mathbb{R}$. From equation \eqref{eq:p3_omega_pm}, this translates to the following constraint on $\omega_0$ and $\omega_z$:  
\begin{equation}\label{eq:p3_omega_constraints}
    \begin{split}
        \omega_0^2 &\geq 2\omega_z^2, \\ 
        \frac{q}{m} &\geq \frac{4V_0}{(B_0d)^2},
    \end{split}
\end{equation} 
where we used the definitions of $\omega_0$ and $\omega_z$ to get a constraint relating the particle properties with the Penning trap parameters. This allows us to choose appropriate parameters for our Penning trap, depending on the mass of the particle we consider. 

Knowing that the particles are bound in the $xy$-plane, we want to consider the upper and lower bounds, $R_+$ and $R_-$ respectively, on the particle's distance from the origin. With $f(t)$ being a complex function, its magnitude is found by $\abs{f(t)}=\sqrt{f(t)f^*(t)}$. Defining $\alpha_\pm \equiv \omega_\pm t + \phi_\pm$ to simplify the expressions, we get 
\begin{equation}\label{eq:p3_magnitude_f_squared}
        \abs{f^2(t)} = A_+^2 + A_-^2 + A_+ A_- \closed{e^{i(\alpha_+ - \alpha_-)} + e^{-i(\alpha_+ - \alpha_-)}}
\end{equation}
Recognizing the sum of the exponentials as the cosine, $\abs{f(t)}$ becomes 
\begin{equation}\label{eq:p3_magnitude_f}
    \abs{f(t)} = \sqrt{A_+^2 + A_-^2 + 2A_+ A_-\cos(\alpha_+ - \alpha_-)}.
\end{equation}
The maximum distance from the origin, $R_+$, occurs when $\alpha_+-\alpha_- = 0 \implies \cos0=1$. Similarily, the minimum distance, $R_-$, is achieved when $\alpha_+-\alpha_- = \pi \implies \cos\pi=-1$. Equation \eqref{eq:p3_magnitude_f} now gives us simple expression for the two bounds  
\begin{align}
    R_+ &= \sqrt{(A_+ + A_-)^2} = A_+ + A_-, \label{eq:p4_Rplus} \\
    R_- &= \sqrt{(A_+ - A_-)^2} = \abs{A_+ - A_-}. \label{eq:p4_Rminus}  
\end{align}


\subsection{Multiple particles}\label{subsec_methods:multiple_particles}
So far, we have only considered the presence of a single particle in the Penning trap. With mulitple particles simultaneously present in the trap, each particle will now be affected by the Coulomb force from the other particles. The electric field at a point $\vec{r}$ due to interactions, $\vec{E}_\mathrm{int}(\vec{r})$, set up by $N_\mathrm{p}$ point charges $\{q_1, q_2, \dots, q_{N_\mathrm{p}}\}$ at positions $\{\vec{r}_1, \vec{r}_2, \dots, \vec{r}_{N_\mathrm{p}}\}$ is given by
\begin{equation}\label{eq:interaction_field}
    \vec{E}_\mathrm{int} (\vec{r}) = k_e \sum_{p=1}^{N_\mathrm{p}} q_p \frac{\vec{r}-\vec{r}_p}{\abs{\vec{r}-\vec{r}_p}^3},
\end{equation}
where $k_e$ is Coulomb's constant. 

The electric field contributing to the Lorentz force in equation \eqref{eq:lorentz_force} is then $\vec{E} = \vec{E}_\mathrm{ext} + \vec{E}_\mathrm{int}$, with the external field given by equation \eqref{eq:p1_E_field_pot_gradient} as before. The magnetic field  Our set of differential equations in equation \eqref{eq:p1_eom_xyz} now get an additional term, and for a particle $i$, the equations become 

\begin{subequations}\label{eq:p4_diffeq_many_particles_xyz}
    \begin{align}
        \ddot{x}_i - \omega_{0,i} \dot{y}_i - \frac{1}{2}\omega_{z,i}^2 x_i - k_e \frac{q_i}{m_i} \sum_{j\neq i} q_j \frac{x_i - x_j}{\abs{\vec{r}_i - \vec{r}_j}^3} =0, \label{eq:p4_diffeq_many_particles_x} \\
        \ddot{y}_i + \omega_{0,i} \dot{x}_i - \frac{1}{2}\omega_{z,i}^2 y_i - k_e \frac{q_i}{m_i} \sum_{j\neq i} q_j \frac{y_i - y_j}{\abs{\vec{r}_i - \vec{r}_j}^3} =0, \label{eq:p4_diffeq_many_particles_y} \\ 
        \ddot{z}_i + \omega_{z,i}^2 z_i - k_e \frac{q_i}{m_i} \sum_{j\neq i} q_j \frac{z_i - z_j}{\abs{\vec{r}_i - \vec{r}_j}^3} =0. \label{eq:p4_diffeq_many_particles_z}
    \end{align}
\end{subequations}
To simplify the analysis, we will neglect any other contribution affecting the motions of the particles inside the trap. 

\section{Methods}\label{sec:methods}


\subsection{Numerical implementation and integration}\label{sec:code}

We aim to create a program in \CC\, that simulates a set of $N_\mathrm{p}$ particles inside a Penning trap. An object-oriented code is befitting this task and we present in the following descriptions of the classes \verb|Particle| and \verb|PenningTrap|.

The purpose of \texttt{Particle} is to hold the parameters, such as the position, of a particle. We let an object of this class be initialised with a charge $q$, a mass $m$, a position $\vec{r} = (x,y,z)$ and a velocity $\vec{v} = (v_x, v_y, v_z)$. We add functions to update the latter two. 

The \texttt{PenningTrap}-class imitates the physical system that is the Penning trap of external electric and magnetic fields according to eqs. \eqref{eq:trap_ext_E_field} and \eqref{eq:trap_ext_B_field}, and characteristic dimension $d$. It is friend with the \texttt{Particle}-class and, in order to resemble the physical situation as much as possible, accepts only input particles of this type. When filled with $N_\mathrm{p}\geq 1$, an object of \texttt{PenningTrap} is ready to simulate the evolution of the \texttt{Particle} object(s) for a given period of time and time step size with either a forward Euler or a fourth order Runge-Kutta numerical scheme. 

\Nanna{Some more here?}

\texttt{PenningTrap} includes several additional functionalites. Amongst other things, the class

\begin{itemize}
    \item offers the choice between RK4 or FE integration method.
    \item provides the option to include or exclude Coloumb interactions in the simulation, as they are computationally greedy.
    \item includes a method for adding a time-dependent perturbation to the external electric potential, $V_0\rightarrow V_0 (1+ f\cos{(\omega_V t)})$.
    \item has the ability to count the number of particles still trapped, that is the number particles whose position $\vec{r}$ is such that $\abs{\vec{r}} \leq d$.
    \item can generate a set of identical particles with positions and velocities that are normally distrubuted within the trap's dimensions.
\end{itemize}

\subsubsection*{Numerical integration - \Vetle{move to appendix?}\Johan{Nei det passer greit her}}
The equation of motion \eqref{eq:eom_lorentz} is split into two first order ODEs as follows:

\begin{equation}\label{eq:split_ODEs}
    \begin{split}
        \dot{\vec{v}} &= \frac{\vec{F}}{m} \\
        \dot{\vec{r}} &= \vec{v}
    \end{split}
\end{equation}

We then get six discretised equations to solve for each particle at each step in time. We use two different approaches when solving equations \ref{eq:split_ODEs} numerically. Both methods are single step methods, meaning we advance one time step per iteration. The simpler method, FE \citep{Atkinson1989} is of first order meaning that we advance one time step by considering the gradient at the current time step only. This results in few FLOPs per iteration. Hence, this scheme offers numerical efficiency. The draw back is the accuracy of the resultant solution. For a step size $h$, the FE scheme has a local truncation error of $\mathcal{O}(h^2)$ which results in a global error $\mathcal{O}(h)$. Since we want $h$ to be small, the global error is large compared to the local error.  

The second, more advanced method is the RK4 methods \citep{Atkinson1989}, which is of fourth order. This means that we advance one time step by considering the gradient four times across a single time step. The gradient we use to advance the solution is a superposition of the four previously found gradients. This results in many FLOPs per iteration. Hence, this scheme is numerically more expensive than the FE scheme. However, it offers a far more accurate solution yielding a local truncation error of $\mathcal{O}(h^5)$ and global error $\mathcal{O}(h^4)$. Again, since $h$ is small, these errors are four magnitudes smaller than those of the FE scheme. 


\subsection{Penning trap parameters and particle properties}\label{subsec_methods:numbers_and_units}
For the Penning trap parameters, we choose the following numerical values:
\begin{itemize}
    \item[] $d=500 \,\mathrm{\text{\textmu} m}$
    \item[] $V_0=25.0 \,\mathrm{mV}$
    \item[] $B_0=1.00 \,\mathrm{T}$
\end{itemize}
We convert all quantities to the following set of base units:
\begin{itemize}
    \item[] Unit-length $=$ one micrometre $= 1\, \mathrm{\text{\textmu}m} $ 
    \item[] Unit-time $=$ one microsecond $= 1\, \mathrm{\text{\textmu}s} $
    \item[] Unit-mass $=$ one atomic mass unit $= 1\, \mathrm{u} $
    \item[] Unit-charge $=$ one elementary charge $= 1\, \mathrm{e} $
\end{itemize}
The particles we consider are Calcium ions (Ca$^+$) with charge $q=1 \,\mathrm{e}$ and mass $m = 40.078 \,\mathrm{u}$. These values ensure that the condition in equation \eqref{eq:p3_omega_constraints} is fulfilled. 


\subsection{Initial conditions}\label{sec:initial_conditions}
For simulations of one or two particles, we use the following initial conditions:
\begin{itemize}
    \item Particle 1\label{item:initial_conditions_p1}
    \begin{itemize}
        \item[] $\vec{r}^{(1)}_0 = (20, \,0, \,20) \, \mathrm{\text{\textmu}m} $
        \item[] $\vec{v}^{(1)}_0 = (0,\,25,\,0) \, \mathrm{\text{\textmu}m}/ \mathrm{\text{\textmu}s}$
    \end{itemize}
    \item Particle 2\label{item:initial_conditions_p2}
    \begin{itemize}
        \item[] $\vec{r}^{(2)}_0 = (25, \,25, \,0) \, \mathrm{\text{\textmu}m} $
        \item[] $\vec{v}^{(2)}_0 = (0,\,40,\,5) \, \mathrm{\text{\textmu}m}/ \mathrm{\text{\textmu}s}$
    \end{itemize}
\end{itemize}



\subsection{Single particle simulation}\label{sec:simulation}
We begin by simulating a single particle, using the initial conditions for Particle 1 in section \ref{sec:initial_conditions}. We compare the resulting axial motion obtained from FE and RK4 with the analytical solution in equation \eqref{eq:p1_diffeq_solution_z} which has the specific solution 
\begin{align}
    z(t) = z_0 \cos(\omega_z t), \label{eq:z_spec_analytical_solution}
\end{align}
where $z_0=20\,\mathrm{\mu s}$. We simulate over a duration of $T_1=50\,\mathrm{\mu s}$, using $n_1=4000$ steps. 

To study the accuracy of the two algorithms, we compute the size of the relative error of the two algorithms as a function of time for a duration of $T_1$. To study the step size dependency, we do this for four different time steps:
\begin{itemize}
    \item[] $n_1 = 4000$
    \item[] $n_2 = 8000$
    \item[] $n_3 = 16000$
    \item[] $n_4 = 32000$
\end{itemize}
The size of the error is given by 
\begin{equation}\label{eq:relative_error_size}
    \Delta_\mathrm{rel,k} = \frac{\abs{\vec{r}_\mathrm{exact} - \vec{r_k}}}{\abs{\vec{r}_\mathrm{exact}}}
\end{equation}
where $\vec{r}_\mathrm{exact}$ is the analytical solution. For the movement in the $xy$-plane, the specific solution for $f(t)$ is given by equation \eqref{eq:p3_f_general_solution} with 
\begin{equation} \label{eq:xy_amplitudes_spec_analytical_solution}
    \begin{split}
        A_+ = \frac{v_0 + \omega_- x_0}{\omega_- - \omega_+},\quad A_- = - \frac{v_0 + \omega_+ x_0}{\omega_- - \omega_+},
        \phi_+ =0,\quad \phi_- =0,
    \end{split}
\end{equation}
where $v_0=\dot{y}(0)=25\,\mathrm{\mu m / \mu s}$ and $x_0=20\,\mathrm{\mu m}$. $z(t)$ is given by equation \eqref{eq:z_spec_analytical_solution}.


% We specify the duration of one simulation as $T$, with $n$ time steps, resulting in a step length of $h = \Delta t = T/n$. We intend to run the simulation for two different durations:
% \begin{itemize}
%     \item[] $T_1 = $ 50 \textmu s
%     \item[] $T_2 = $ 500 \textmu s
% \end{itemize}
% However, deviation from this may occur if computations proves to be lengthy, or if we want a specific step length. 

% For simulations of duration $T_1$ with different number of steps, we will use an estimate of the error convergence rate $r_\mathrm{err}$ given by

Using the results of the estimated errors, we will estimate the error convergence rate, $r_\mathrm{err}$ for our two algorithms 
\begin{equation}\label{eq:error_convergence_rate}
    r_\mathrm{err} = \frac{1}{3} \sum_{k=2}^{4} \frac{\log{\big(\Delta_{\mathrm{max}, k} /\Delta_{\mathrm{max}, k-1}\big)}}{\log{\big(h_k/h_{k-1} \big)}},
\end{equation}
where $h_k =T_1/n_k$ is the step size and
\begin{equation}\label{eq:abs_error}
    \Delta_{\mathrm{max}, k} = \max_{i}\abs{\vec{r}_{i, \mathrm{exact}} - \vec{r}_i}
\end{equation}
is the maximum absolute error in the solution obtained with $n_k$ time steps. We used that $\vec{r}_{i, \mathrm{exact}}$ is the analytical solution.

\subsubsection{Single particle}

\subsubsection{Two particles}

\subsection{Many particles - Resonance}
Now that the basics of our Penning trap is complete, we explore resonance features of our trap when we have a large number of particles in the trap. To to this, we subject the system to a timedependent electromagnetic field  by making the replacement 
\begin{equation}
    V_0 \to V_0 (1 + f \cos(\omega_V t)), \label{eq:p9_time_dep_potential}
\end{equation} 
where $f$ is a constant amplitude and $\omega_V$ is the angular frequency of the time-dependent potential. Using this potential, we will consider $N_p=100$ particles with normal distributed initial positions and velocities with a mean of zero and variance $\sigma^2=1$. The magnitude of each particle's initial position and velocity vector is $d/10$. To find potential resonance frequencies, we will plot the fraction of particles that are left in the trap after a duration of $T_2=500\,\mathrm{\mu s}$ as a function of applied frequency $\omega_V\in(0.2,\,2.5)\,\mathrm{MHz}$. For this broad frequency range we use a step size of $0.02\,\mathrm{MHz}$ for the applied frequencies and switch off the interactions between the particles. We plot the result for the three amplitudes $f=0.1,\,0.4,\,0.7$. \Vetle{Need steps etc...}


Having completed a broad frequency search, we proceed by 



































% ===========================================
%\subsection*{The algorithm}


% Started drafting:
% Kinda lost track of what i am trying to do

% \begin{figure}
%     \begin{algorithm}[H]
%     \scriptsize
%     \caption{Forward Euler (FE)}
%     \label{algo:FE}
%         \begin{algorithmic}
%             %\Procedure{FE differentiation}{$f, a, b, n$}
%             \State $U_0 \leftarrow \dots$        \Comment{Initialise velocities in cube} % matrix of row vectors v_0
%             \State $R_0 \leftarrow \dots$        \Comment{Initialise positions in cube}
%             \State $h \leftarrow (t_n-t_0)/n$  \Comment{Compute the time step length}
%             \For{$i = 0, 1, \ldots, n-1$}
%             \For{each particle}
%             \State $\vec{v} \leftarrow U_{i,\text{particle}}$
%             \State $\vec{r} \leftarrow R_{i,\text{particle}}$
%             \State $\text{d}U_{i, \text{particle}} \leftarrow h \vec{F}(\vec{r}, \vec{v})/m$
%             \State $\text{d}R_{i, \text{particle}} \leftarrow h (\vec{v} + \text{d}U_{i, \text{particle}})$ 
%             \EndFor

%             \State $U_{i+1} \leftarrow U_{i} + \text{d}U_{i}$ \Comment{Update velocities}
%             \State $R_{i+1} \leftarrow R_{i} + \text{d}R_{i}$ \Comment{Update positions}
%             \EndFor
%             %\EndProcedure
%         \end{algorithmic}
%     \end{algorithm}
% \end{figure}

% \begin{figure}
%     \begin{algorithm}[H]
%     \scriptsize
%     \caption{4$^\text{th}$ order Runge-Kutta (RK4)}
%     \label{algo:RK4}
%         \begin{algorithmic}
%             %\Procedure{RK4 differentiation}{$\vec{F}, t_n, t_0, n$}
%             \State $U_0 \leftarrow \dots$        \Comment{Initialise velocities in cube} % matrix of row vectors v_0
%             \State $R_0 \leftarrow \dots$        \Comment{Initialise positions in cube}
%             \State $h \leftarrow (t_n-t_0)/n$  \Comment{Compute the time step length}
%             \For{$i = 0, 1, \ldots, n-1$}
%             \For{each particle}
%             \State $\vec{v} \leftarrow U_{i,\text{particle}}$
%             \State $\vec{r} \leftarrow R_{i,\text{particle}}$
%             \State $\vec{k}_{\vec{v},1} \leftarrow h \vec{F}(\vec{r}, \vec{v})/m$ \Comment{...}
%             \State $\vec{k}_{\vec{r},1} \leftarrow h \vec{v}$
%             \State $\vec{k}_{\vec{v},2} \leftarrow h \vec{F}(\vec{r}+1/2\vec{k}_{\vec{r},1}, \vec{v}+1/2\vec{k}_{\vec{v},1})/m$ \Comment{...}
%             \State $\vec{k}_{\vec{r},2} \leftarrow h (\vec{v}+1/2\vec{k}_{\vec{v},1})$ 
%             \State $\vec{k}_{\vec{v},3} \leftarrow h \vec{F}(\vec{r}+1/2\vec{k}_{\vec{r},2}, \vec{v}+1/2\vec{k}_{\vec{v},2})/m$ \Comment{...}
%             \State $\vec{k}_{\vec{r},3} \leftarrow h (\vec{v}+1/2\vec{k}_{\vec{v},2})$ 
%             \State $\vec{k}_{\vec{v},4} \leftarrow h \vec{F}(\vec{r}+\vec{k}_{\vec{r},3}, \vec{v}+\vec{k}_{\vec{v},3})/m$ \Comment{...}
%             \State $\vec{k}_{\vec{r},4} \leftarrow h (\vec{v}+\vec{k}_{\vec{v},3})$ 
%             \
%             \State $\text{d}U_{i, \text{particle}} \leftarrow (\vec{k}_{\vec{v},1} + 2\vec{k}_{\vec{v},2} + 2\vec{k}_{\vec{v},3} + \vec{k}_{\vec{v},4})/6$
%             \State $\text{d}R_{i, \text{particle}} \leftarrow (\vec{k}_{\vec{r},1} + 2\vec{k}_{\vec{r},2} + 2\vec{k}_{\vec{r},3} + \vec{k}_{\vec{r},4})/6$
%             \EndFor

%             \State $U_{i+1} \leftarrow U_{i} + \text{d}U_{i}$ \Comment{Update velocities}
%             \State $R_{i+1} \leftarrow R_{i} + \text{d}R_{i}$ \Comment{Update positions}
%             \EndFor
%             \State $...$  \Comment{...}
%             %\EndProcedure
%         \end{algorithmic}
%     \end{algorithm}
% \end{figure}
    

%
%use equation~\cite{midpoint_rule}
%\begin{figure}
%% NOTE: We only need \begin{figure} ... \end{figure} here because of a compatability issue between the 'revtex4-1' document class and the 'algorithm' environment.
    %\begin{algorithm}[H]
    %\caption{Midpoint rule for integration}
    %\label{algo:midpointrule}
        %\begin{algorithmic}
            %\Procedure{Midpoint rule}{$f, a, b, n$}
            %\State $I \leftarrow 0$        \Comment{Initialize the integral variable}
            %\State $h \leftarrow (b-a)/n$  \Comment{Compute the interval length}
            %\For{$i = 1, 2, \ldots, n$}
            %\State $x \leftarrow a + (i-1/2)h$  \Comment{Assign $x$ to the midpoint}  %This means x is assigned the value x + ih/2.
            %\State $I \leftarrow I + f(x)$  \Comment{Add contribution to integral} %Assign I to I + f(x)
            %\EndFor
            %\State $I \leftarrow Ih$  \Comment{Finalize the computation}
            %\EndProcedure
        %\end{algorithmic}
    %\end{algorithm}
%\end{figure}


% ===========================================
